name: Build and Release

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Configure CMake
      run: cmake -B build -G "Visual Studio 17 2022" -A x64

    - name: Build
      run: cmake --build build --config Release

    - name: Upload DLL artifact
      uses: actions/upload-artifact@v4
      with:
        name: NewFolderFromFiles-DLL
        path: build/bin/Release/NewFolderFromFiles.dll

    - name: Upload Hotkey Helper artifact
      uses: actions/upload-artifact@v4
      with:
        name: NewFolderFromFiles-Hotkey
        path: build/bin/Release/NewFolderFromFilesHotkey.exe

    - name: Install Inno Setup
      run: choco install innosetup -y

    - name: Build Installer
      run: |
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer\setup.iss

    - name: Setup Windows SDK (for signtool)
      uses: microsoft/setup-msbuild@v2  # Already have this, but ensures SDK

    - name: Code Sign EXE, DLL, and Installer
      shell: pwsh
      env:
        CERT_PFX_BASE64: ${{ secrets.SELF_SIGN_PFX_BASE64 }}
        CERT_PASSWORD: ${{ secrets.SELF_SIGN_PASSWORD }}
      run: |
        # Decode PFX
        $pfxBytes = [Convert]::FromBase64String($env:CERT_PFX_BASE64)
        $pfxPath = "cert.pfx"
        [IO.File]::WriteAllBytes($pfxPath, $pfxBytes)
        
        # Find signtool (works on GitHub Actions windows-latest)
        $signtool = "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe"
        if (-not (Test-Path $signtool)) {
          $signtool = "C:\Program Files (x86)\Microsoft SDKs\ClickOnce\SignTool\signtool.exe"
        }
        if (-not (Test-Path $signtool)) {
          Write-Error "signtool not found"
          exit 1
        }
        Write-Output "Using signtool: $signtool"
        
        # Sign Hotkey EXE
        & $signtool sign /f $pfxPath /p $env:CERT_PASSWORD /tr http://timestamp.digicert.com /td sha256 /fd sha256 "build/bin/Release/NewFolderFromFilesHotkey.exe"
        
        # Sign DLL
        & $signtool sign /f $pfxPath /p $env:CERT_PASSWORD /tr http://timestamp.digicert.com /td sha256 /fd sha256 "build/bin/Release/NewFolderFromFiles.dll"
        
        # Sign Installer
        & $signtool sign /f $pfxPath /p $env:CERT_PASSWORD /tr http://timestamp.digicert.com /td sha256 /fd sha256 "build/NewFolderFromFiles-Setup.exe"
        
        # Verify
        & $signtool verify /pa /v "build/NewFolderFromFiles-Setup.exe"
        Write-Output "âœ… All files signed successfully!"

    - name: Upload Installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: NewFolderFromFiles-Setup
        path: build/NewFolderFromFiles-Setup.exe

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write   # needed to create releases

    steps:
      - name: Download installer
        uses: actions/download-artifact@v4
        with:
          name: NewFolderFromFiles-Setup

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: NewFolderFromFiles-Setup.exe
          generate_release_notes: true
